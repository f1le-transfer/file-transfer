<pre>
   ___       ___                      __                                        ___                
 /'___\  __ /\_ \                    /\ \__                                   /'___\               
/\ \__/ /\_\\//\ \       __          \ \ ,_\  _ __    __       ___      ____ /\ \__/    __   _ __  
\ \ ,__\\/\ \ \ \ \    /'__`\  _______\ \ \/ /\`'__\/'__`\   /' _ `\   /',__\\ \ ,__\ /'__`\/\`'__\
 \ \ \_/ \ \ \ \_\ \_ /\  __/ /\______\\ \ \_\ \ \//\ \L\.\_ /\ \/\ \ /\__, `\\ \ \_//\  __/\ \ \/ 
  \ \_\   \ \_\/\____\\ \____\\/______/ \ \__\\ \_\\ \__/.\_\\ \_\ \_\\/\____/ \ \_\ \ \____\\ \_\ 
   \/_/    \/_/\/____/ \/____/           \/__/ \/_/ \/__/\/_/ \/_/\/_/ \/___/   \/_/  \/____/ \/_/
</pre>

![CodeQL](https://github.com/loveyousomuch554/file-transfer/workflows/CodeQL/badge.svg?branch=main)

# Info

<p>Documentation will be updated. ðŸ™‚</p>

Current stage of the project: <u>working on project documentation</u>.

#### Frequent errors:

Error while installing npm modules:

```shell
Error: 
  Cannot find module 'path_to_my_project/node_modules/bcrypt/lib/binding/napi-v3/bcrypt_lib.node'
```

Solution: <br>

```Shell
cd node_modules/bcrypt
node-pre-gyp install --fallback-to-build
```

## Testing

<p>For testing with logs run the following commands:</p>

```shell
npm run test
```

Without logs:

```shell
npm run test -- --silent
```

## Server

Run server:     

```shell
npm run prod
```

Dev server: 

```shell
npm run watch:dev
```

Docker:

```shell
docker build -t file-transfer -f $PWD/etc/Dockerfile $PWD
```

```shell
docker run -dp 80:80 file-transfer 
```

# Docs

### Subscribers

`/src/server/subscribers/`

#### TrackAFK

After each user login, a session and a `last activity` document (timeout) are created. This timeout defines the amount of time a session will remain active in case there is no activity in the session, closing and invalidating the session upon the defined idle period since the last HTTP request received by the web application for a given session ID.
Btw, the same result can be achieved using `createIndexes` - <http://mongodb.github.io/node-mongodb-native/3.6/api/Collection.html#createIndexes>

# API

<!-- Generated by documentation.js. Update this documentation by updating the source code. -->

### Table of Contents

-   [User](#user)
    -   [Parameters](#parameters)
    -   [toJSON](#tojson)
    -   [comparePassword](#comparepassword)
        -   [Parameters](#parameters-1)
    -   [encoded](#encoded)
    -   [isUserLogin](#isuserlogin)
    -   [decoded](#decoded)
        -   [Parameters](#parameters-2)
-   [validateCredential](#validatecredential)
    -   [Parameters](#parameters-3)
-   [isPwdSuitable](#ispwdsuitable)
    -   [Parameters](#parameters-4)
-   [isUsrSuitable](#isusrsuitable)
    -   [Parameters](#parameters-5)
-   [logoutAndUpdateUsr](#logoutandupdateusr)
    -   [Parameters](#parameters-6)
-   [TrackAFK_DAO](#trackafk_dao)
-   [insertOne](#insertone)
-   [command](#command)
-   [getUser](#getuser)
    -   [Parameters](#parameters-7)
-   [getUser](#getuser-1)
    -   [Parameters](#parameters-8)
-   [addUser](#adduser)
    -   [Parameters](#parameters-9)
-   [loginUser](#loginuser)
    -   [Parameters](#parameters-10)
-   [deleteUser](#deleteuser)
    -   [Parameters](#parameters-11)
-   [logoutUser](#logoutuser)
    -   [Parameters](#parameters-12)
-   [getUserSession](#getusersession)
    -   [Parameters](#parameters-13)
-   [changeUserData](#changeuserdata)
    -   [Parameters](#parameters-14)

## User

TODO:
 1\. Write tests for update pwd.
 2\. Fix a bug with deleting an account when the user is not logged. Rewrite `delete` method with `authenticate`.
 3\. In the future, add separate functions for changing user data with two-factor authentication.

### Parameters

-   `$0` **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)**  (optional, default `{}`)
    -   `$0.username`  
    -   `$0.pwd`  

### toJSON

Return object in JSON format.

Returns **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 

### comparePassword

Compare passwords.

#### Parameters

-   `plainText`  The password to be compared with the real one

Returns **[Boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** 

### encoded

Create JSON Web Token.

Returns **[String](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/String)** 

### isUserLogin

Check is user login(user session exist).

Returns **[Boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** 

### decoded

Get user data from jwt token.

#### Parameters

-   `userJwt`  JSON Web Token

Returns **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 

## validateCredential

Checks password and login.

### Parameters

-   `userFromBody`  user object from request
-   `errors`  error logging object

## isPwdSuitable

Password must be at least 8 characters and less than 65
Must include: lowercase letter, capital letter,
number, special character (!@#$%^&\*)
Can include any unicode character.

### Parameters

-   `pwd`  

Returns **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** 

## isUsrSuitable

Login must be at least 3 characters and less than 16
Can include: A-Z, a-z, 0-9 and (-!@#$%^&\*).

### Parameters

-   `username`  

Returns **[boolean](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Boolean)** 

## logoutAndUpdateUsr

Logs out of the account and returns the updated user.

### Parameters

-   `new_user`  Data of new user.
-   `old_username`  Previous username to log out of account, by default current username. (optional, default `new_user.username`)

Returns **({user} | {error})** 

## TrackAFK_DAO

TODO: review code and write documentation

## insertOne

Set or update the last user activity.
The index of the document `last activity` is the same as the index of the session.

## command

At this point, do not need to check the existence of collections,
because they are created above when defining indexes.

## getUser

Some of the methods below use {username: username} instead of {username}
to avoid specifying a user by other fields.

### Parameters

-   `username`  

## getUser

Finds a user in `users` collection.

### Parameters

-   `username`  Login of the searched user

Returns **([Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object) | null)** Returns either user object or nothing(null)

## addUser

Adds a user to the `users` collection.

### Parameters

-   `userInfo`  The information about user

Returns **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** Returns either a "success" or an "error" Object

## loginUser

Adds a user to the `sessions` collection.

### Parameters

-   `username`  The username to login
-   `jwt`  A JSON web token representing the user's claims

Returns **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** Returns either a "success" or an "error" Object

## deleteUser

Removes a user from the `sessions` and `users` collections.

### Parameters

-   `username`  The username of the user to delete

Returns **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** Returns either a "success" or an "error" Object

## logoutUser

Removes a user from the `session` collection.

### Parameters

-   `username`  The username of the user to logout

Returns **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** Returns either a "success" or an "error" Object

## getUserSession

Gets a user session from the `sessions` collection.

### Parameters

-   `usernameOrId`  The username or ID of the user to search for in `sessions`.

Returns **([Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object) | null)** Returns a user session Object, an "error" Object
if something went wrong, or null if user was not found.

## changeUserData

Updates user data.

### Parameters

-   `username`  The username of the user update
-   `fields`  The fields to update

Returns **[Object](https://developer.mozilla.org/docs/Web/JavaScript/Reference/Global_Objects/Object)** 
