<html>
  <head>
    <link rel="manifest" href="/manifest.json">
    <link rel="apple-touch-icon" href="/img/1.jpeg">

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#764ABC"/>
  </head>
  <body>
    <span>You are now</span> <span><b class="page-status">online</b></span><br>
    <button id="open_btn">open file</button><br>
    <button id="send_btn">send file</button>

    <script src="/pwa.js"></script>
    <script src="/status.js"></script>
    <script>
      // Channel for communicate between window and worker
      const broadcast = new BroadcastChannel('tcp_channel'); 
      broadcast.addEventListener('message', ({ data }) => console.log(data))

      document.getElementById('send_btn').onclick = () => {
        broadcast.postMessage({ msg: prompt('msg?') })
      };

      let fileHandle;
      document.getElementById('open_btn').addEventListener('click', async () => {
        // Destructure the one-element array.
        [fileHandle] = await window.showOpenFilePicker();
        const [filename, ext] = fileHandle.name.split('.')

        const file = await fileHandle.getFile();
        const file_stream = file.stream();

        new Promise((resolve, reject) => {
          const reader = file_stream.getReader()
          resolve({
            filename,
            ext,
            stream:
              new ReadableStream({
                start(controller) {
                  // The following function handles each data chunk
                  function push() {
                    // "done" is a Boolean and value a "Uint8Array"
                    reader.read({ byob: 4096 }).then( ({done, value}) => {
                      // If there is no more data to read
                      if (done) {
                        console.log(`Done:`, done);
                        controller.close();
                        return;
                      }
                      // Get the data and send it to the browser via the controller
                      controller.enqueue(value);
                      // Check chunks by logging to the console
                      console.log(`Done:`, done, 'length:', value.length, Object.getPrototypeOf(value));
                      push();
                    })
                  }
                  push();
                }
              })
          })
        })
        .then(({ stream, filename, ext}) => {
          return new Response(stream, { headers: { "Content-Type": "text/html", "filename": filename } }).text();
        })
        .then(result => {
          console.log(result)
          broadcast.postMessage({ msg: result })
        })
      });
    </script>
  </body>
</html>